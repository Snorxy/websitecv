<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gabung TXT - TXT Converter</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .navbar-brand, .nav-link {
            color: white !important;
        }

        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2) !important;
            border-radius: 8px !important;
            font-weight: 600 !important;
        }

        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1) !important;
            border-radius: 8px !important;
        }

        .navbar .text-muted {
            color: rgba(255, 255, 255, 0.8) !important;
        }

        .main-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .wizard-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .wizard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 2rem;
            text-align: center;
        }

        .wizard-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .wizard-subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 2rem;
            margin: 2rem 0;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
            max-width: 150px;
        }

        .step-number {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
        }

        .step.active .step-number {
            background: white;
            color: #667eea;
            transform: scale(1.1);
        }

        .step.completed .step-number {
            background: #28a745;
            color: white;
        }

        .step-label {
            color: rgba(255, 255, 255, 0.8);
            font-weight: 500;
            text-align: center;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .step.active .step-label {
            color: white;
            font-weight: 600;
        }

        .step.completed .step-label {
            color: white;
            font-weight: 500;
        }

        .step-connector {
            position: absolute;
            top: 25px;
            left: 75px;
            width: calc(100% - 50px);
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            z-index: -1;
        }

        .step:last-child .step-connector {
            display: none;
        }
        

        .step-content {
            padding: 40px;
        }

        .upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 20px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: rgba(248, 249, 250, 0.8);
        }

        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 4rem;
            color: #6c757d;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .upload-area:hover .upload-icon {
            color: #667eea;
            transform: scale(1.1);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
            padding: 12px 30px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .form-control, .form-select {
            border-radius: 15px;
            border: 2px solid #e9ecef;
            padding: 12px 16px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .alert {
            border-radius: 15px;
            border: none;
        }

        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .processing-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .success-icon {
            animation: bounceIn 0.6s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .file-item {
            transition: all 0.3s ease;
        }

        .file-item:hover {
            transform: translateX(5px);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .wizard-title {
                font-size: 2rem;
            }
            
            .step {
                margin: 0 10px;
            }
            
            .step-connector {
                width: 50px;
            }
            
            .upload-area {
                padding: 40px 15px;
            }
            
            .step-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="bi bi-file-text"></i> Werewolf CV
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i class="bi bi-house"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('txt_to_vcf') }}">
                            <i class="bi bi-arrow-up-circle"></i> TXT to VCF
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('vcf_to_txt') }}">
                            <i class="bi bi-arrow-down-circle"></i> VCF to TXT
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('admin_navy') }}">
                            <i class="bi bi-people"></i> Admin & Navy
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('gabung_txt') }}">
                            <i class="bi bi-union"></i> Gabung TXT
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('gabung_vcf') }}">
                            <i class="bi bi-collection"></i> Gabung VCF
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('split_txt') }}">
                            <i class="bi bi-scissors"></i> Split TXT
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <span class="nav-link">
                            <i class="bi bi-person-circle"></i> API: {{ session.api_key }}
                            {% if api_key_expiry %}
                            <br><small class="text-muted" style="font-size: 0.7rem;">
                                <i class="bi bi-clock"></i> {{ api_key_expiry }}
                                {% if api_key_remaining_days >= 0 %}
                                    ({{ api_key_remaining_days }}h)
                                {% else %}
                                    <span class="text-danger">(EXP)</span>
                                {% endif %}
                            </small>
                            {% endif %}
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('logout') }}">
                            <i class="bi bi-box-arrow-right"></i> Logout
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="main-container">
        <div class="wizard-container">
            <!-- Header -->
            <div class="wizard-header">
                <h1 class="wizard-title">
                    <i class="bi bi-union"></i> Gabung TXT Files
                </h1>
                <p class="wizard-subtitle">Gabungkan multiple file TXT menjadi satu file dengan opsi kustomisasi</p>
                
                <!-- Step Indicators -->
                <div class="step-indicator">
                    <div class="step active" id="step1">
                        <div class="step-number">1</div>
                        <div class="step-label">Upload Files</div>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step" id="step2">
                        <div class="step-number">2</div>
                        <div class="step-label">Konfigurasi</div>
                    </div>
                    <div class="step-connector"></div>
                    <div class="step" id="step3">
                        <div class="step-number">3</div>
                        <div class="step-label">Download</div>
                    </div>
                </div>
            </div>

            <!-- Step Contents -->
            <form id="gabungTxtForm" enctype="multipart/form-data">
                <!-- Step 1: Upload Files -->
                <div class="step-content" id="step1-content">
                    <div class="upload-area" id="uploadArea" onclick="document.getElementById('txt_files').click()">
                        <i class="bi bi-cloud-upload upload-icon"></i>
                        <h4>Pilih atau Drop Multiple File TXT</h4>
                        <p class="text-muted mb-3">Minimal 2 file TXT diperlukan untuk digabung</p>
                        <input type="file" 
                               id="txt_files" 
                               name="txt_files" 
                               multiple 
                               accept=".txt" 
                               style="display: none;">
                        <button type="button" class="btn btn-primary">
                            <i class="bi bi-folder2-open"></i> Pilih File TXT
                        </button>
                    </div>

                    <!-- Selected Files Display -->
                    <div id="selectedFiles" class="d-none mt-4">
                        <h5><i class="bi bi-list-ul"></i> File yang Dipilih:</h5>
                        <div id="filesList" class="border rounded p-3 bg-light">
                            <!-- Files will be listed here -->
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Total file: <span id="filesCount">0</span></small>
                        </div>
                    </div>

                    <div class="text-center mt-4">
                        <button type="button" class="btn btn-primary" onclick="handleNextStep()" id="nextStepBtn" disabled>
                            <i class="bi bi-arrow-right"></i> Lanjut ke Konfigurasi
                        </button>
                    </div>
                </div>

                <!-- Step 2: Merge Settings -->
                <div class="step-content d-none" id="step2-content">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="output_filename" class="form-label">
                                    <i class="bi bi-file-earmark-text"></i> Nama File Output
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="output_filename" 
                                       name="output_filename" 
                                       placeholder="merged_files" 
                                       value="merged_files">
                                <div class="form-text">Ekstensi .txt akan ditambahkan otomatis</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="separator_option" class="form-label">
                                    <i class="bi bi-grip-horizontal"></i> Separator Antar File
                                </label>
                                <select class="form-select" id="separator_option" name="separator_option">
                                    <option value="none" selected>Tanpa Separator</option>
                                    <option value="newline">1 Baris Kosong</option>
                                    <option value="double_newline">2 Baris Kosong</option>
                                    <option value="dash">Garis (---)</option>
                                    <option value="custom">Custom Separator</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3" id="customSeparatorDiv" style="display: none;">
                                <label for="custom_separator" class="form-label">
                                    <i class="bi bi-text-left"></i> Custom Separator
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="custom_separator" 
                                       name="custom_separator" 
                                       placeholder="===== SEPARATOR =====">
                                <div class="form-text">Separator yang akan disisipkan antar file</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" 
                                           type="checkbox" 
                                           id="add_filename_headers" 
                                           name="add_filename_headers">
                                    <label class="form-check-label" for="add_filename_headers">
                                        <i class="bi bi-card-heading"></i> Tambahkan Header Nama File
                                    </label>
                                    <div class="form-text">Menambahkan nama file sebagai header di setiap bagian</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preview -->
                    <div class="alert alert-light border">
                        <h6><i class="bi bi-eye"></i> Preview Hasil:</h6>
                        <div id="mergePreview" class="p-3 border rounded" style="background: rgba(255, 255, 255, 0.9); font-family: monospace; white-space: pre-line; max-height: 200px; overflow-y: auto;">
                            <!-- Preview akan muncul di sini -->
                        </div>
                    </div>

                    <div class="text-center">
                        <button type="button" class="btn btn-secondary me-2" onclick="nextStep(1)">
                            <i class="bi bi-arrow-left"></i> Kembali
                        </button>
                        <button type="button" class="btn btn-primary" onclick="handleProcessMerge()">
                            <i class="bi bi-download"></i> Gabung & Download
                        </button>
                    </div>
                </div>

                <!-- Step 3: Processing/Download -->
                <div class="step-content d-none" id="step3-content">
                    <div class="text-center processing-animation" id="processing-content">
                        <div class="spinner-border text-primary mb-3" role="status" id="processing-spinner" style="width: 4rem; height: 4rem;">
                            <span class="visually-hidden">Processing...</span>
                        </div>
                        <h4 id="processing-text">Menggabungkan file...</h4>
                        <p class="text-muted" id="processing-detail">Mohon tunggu sebentar</p>
                    </div>

                    <div class="d-none" id="success-content">
                        <div class="text-center">
                            <i class="bi bi-check-circle-fill text-success display-3 mb-3 success-icon"></i>
                            <h4 class="text-success">Gabung File Berhasil!</h4>
                            <p class="text-muted">File TXT gabungan telah dibuat dan akan didownload otomatis</p>
                            
                            <div class="alert alert-success">
                                <div class="row text-start">
                                    <div class="col-md-6">
                                        <strong>Total File Digabung:</strong> <span id="result-files-count">0</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Ukuran File:</strong> <span id="result-file-size">0 KB</span>
                                    </div>
                                </div>
                                <hr>
                                <div class="text-center">
                                    <strong>Nama File:</strong> <span id="result-filename">-</span>
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary" onclick="resetForm()">
                                <i class="bi bi-arrow-counterclockwise"></i> Gabung File Lagi
                            </button>
                        </div>
                    </div>

                    <div class="d-none" id="error-content">
                        <div class="text-center">
                            <i class="bi bi-exclamation-circle-fill text-danger display-3 mb-3"></i>
                            <h4 class="text-danger">Terjadi Kesalahan</h4>
                            <p class="text-muted" id="error-message">Error tidak diketahui</p>
                            
                            <button type="button" class="btn btn-secondary" onclick="nextStep(2)">
                                <i class="bi bi-arrow-left"></i> Kembali ke Konfigurasi
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Info Card -->
        <div class="row justify-content-center mt-4">
            <div class="col-lg-10">
                <div class="card">
                    <div class="card-body p-4">
                        <h5 class="card-title">
                            <i class="bi bi-info-circle text-info"></i> Cara Penggunaan
                        </h5>
                        <div class="row">
                            <div class="col-md-4">
                                <h6><i class="bi bi-1-circle text-primary"></i> Upload Files</h6>
                                <ul class="list-unstyled">
                                    <li>• Pilih minimal 2 file TXT</li>
                                    <li>• Drag & drop atau klik pilih file</li>
                                    <li>• Format file: .txt</li>
                                    <li>• Encoding: UTF-8 atau Latin-1</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="bi bi-2-circle text-primary"></i> Konfigurasi</h6>
                                <ul class="list-unstyled">
                                    <li>• Tentukan nama file output</li>
                                    <li>• Pilih separator antar file</li>
                                    <li>• Opsi header nama file</li>
                                    <li>• Preview hasil gabungan</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6><i class="bi bi-3-circle text-primary"></i> Download</h6>
                                <ul class="list-unstyled">
                                    <li>• Proses gabung otomatis</li>
                                    <li>• Download file hasil</li>
                                    <li>• Lihat statistik gabungan</li>
                                    <li>• Opsi untuk gabung lagi</li>
                                </ul>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <strong><i class="bi bi-lightbulb"></i> Hasil:</strong> Satu file TXT yang berisi gabungan semua file dengan format sesuai pilihan Anda.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
let currentStep = 1;
let selectedFiles = [];

// File upload handling
document.getElementById('txt_files').addEventListener('change', function(e) {
    handleFileSelection(e.target.files);
});

// Drag and drop handling
const uploadArea = document.getElementById('uploadArea');

uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    handleFileSelection(e.dataTransfer.files);
});

// Handle file selection
function handleFileSelection(files) {
    selectedFiles = Array.from(files).filter(file => file.name.toLowerCase().endsWith('.txt'));
    
    console.log('Selected files:', selectedFiles.length);
    
    if (selectedFiles.length === 0) {
        alert('Pilih file dengan ekstensi .txt');
        return;
    }
    
    if (selectedFiles.length < 2) {
        alert('Minimal 2 file TXT diperlukan untuk digabung');
        return;
    }
    
    displaySelectedFiles();
    document.getElementById('nextStepBtn').disabled = false;
}

// Display selected files
function displaySelectedFiles() {
    const filesList = document.getElementById('filesList');
    const filesCount = document.getElementById('filesCount');
    
    let html = '';
    selectedFiles.forEach((file, index) => {
        const size = (file.size / 1024).toFixed(1);
        html += `
            <div class="d-flex justify-content-between align-items-center mb-2 p-3 rounded border file-item" style="background: rgba(255, 255, 255, 0.9);">
                <div>
                    <i class="bi bi-file-earmark-text text-primary me-2"></i>
                    <span class="fw-bold">${file.name}</span>
                    <small class="text-muted ms-2">(${size} KB)</small>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${index})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        `;
    });
    
    filesList.innerHTML = html;
    filesCount.textContent = selectedFiles.length;
    document.getElementById('selectedFiles').classList.remove('d-none');
}

// Remove file
function removeFile(index) {
    selectedFiles.splice(index, 1);
    
    if (selectedFiles.length < 2) {
        document.getElementById('selectedFiles').classList.add('d-none');
        document.getElementById('nextStepBtn').disabled = true;
    } else {
        displaySelectedFiles();
    }
}

// Step navigation
function nextStep(step) {
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(content => {
        content.classList.add('d-none');
    });
    
    // Remove all active step indicators
    document.querySelectorAll('.step').forEach(indicator => {
        indicator.classList.remove('active');
        indicator.classList.remove('completed');
    });
    
    // Mark completed steps
    for(let i = 1; i < step; i++) {
        document.getElementById(`step${i}`).classList.add('completed');
    }
    
    // Show target step
    document.getElementById(`step${step}-content`).classList.remove('d-none');
    document.getElementById(`step${step}`).classList.add('active');
    
    currentStep = step;
    
    if (step === 2) {
        updatePreview();
    }
}

// Handle next step
function handleNextStep() {
    if (selectedFiles.length < 2) {
        alert('Minimal 2 file TXT diperlukan untuk digabung');
        return;
    }
    
    nextStep(2);
}

// Update separator options
document.getElementById('separator_option').addEventListener('change', function() {
    const customDiv = document.getElementById('customSeparatorDiv');
    if (this.value === 'custom') {
        customDiv.style.display = 'block';
    } else {
        customDiv.style.display = 'none';
    }
    updatePreview();
});

// Update preview when settings change
document.getElementById('add_filename_headers').addEventListener('change', updatePreview);
document.getElementById('custom_separator').addEventListener('input', updatePreview);

// Update preview
function updatePreview() {
    const separatorOption = document.getElementById('separator_option').value;
    const customSeparator = document.getElementById('custom_separator').value;
    const addHeaders = document.getElementById('add_filename_headers').checked;
    
    let preview = '';
    
    selectedFiles.forEach((file, index) => {
        if (addHeaders) {
            preview += `=== ${file.name} ===\n`;
        }
        preview += `[Isi dari ${file.name}]\n`;
        
        if (index < selectedFiles.length - 1) {
            switch(separatorOption) {
                case 'newline':
                    preview += '\n';
                    break;
                case 'double_newline':
                    preview += '\n\n';
                    break;
                case 'dash':
                    preview += '---\n';
                    break;
                case 'custom':
                    if (customSeparator) {
                        preview += customSeparator + '\n';
                    }
                    break;
            }
        }
    });
    
    document.getElementById('mergePreview').textContent = preview;
}

// Handle process merge
function handleProcessMerge() {
    if (selectedFiles.length < 2) {
        alert('Minimal 2 file TXT diperlukan untuk digabung');
        return;
    }
    
    processMerge();
}

// Process merge
function processMerge() {
    // Go to step 3
    nextStep(3);
    
    // Show processing
    document.getElementById('processing-content').classList.remove('d-none');
    document.getElementById('success-content').classList.add('d-none');
    document.getElementById('error-content').classList.add('d-none');
    document.getElementById('processing-text').textContent = 'Menggabungkan file...';
    document.getElementById('processing-detail').textContent = `Memproses ${selectedFiles.length} file`;
    
    // Prepare form data
    const formData = new FormData();
    
    selectedFiles.forEach(file => {
        formData.append('txt_files', file);
    });
    
    formData.append('output_filename', document.getElementById('output_filename').value);
    formData.append('separator_option', document.getElementById('separator_option').value);
    formData.append('custom_separator', document.getElementById('custom_separator').value);
    formData.append('add_filename_headers', document.getElementById('add_filename_headers').checked);
    
    // Send request
    fetch('/gabung_txt_files', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.blob().then(blob => ({
                blob: blob,
                filename: response.headers.get('Content-Disposition')?.split('filename=')[1]?.replace(/"/g, '') || 'merged_files.txt'
            }));
        } else {
            return response.json().then(data => Promise.reject(data));
        }
    })
    .then(data => {
        // Hide processing
        document.getElementById('processing-content').classList.add('d-none');
        
        // Show success
        document.getElementById('success-content').classList.remove('d-none');
        document.getElementById('result-files-count').textContent = selectedFiles.length;
        document.getElementById('result-file-size').textContent = (data.blob.size / 1024).toFixed(1) + ' KB';
        document.getElementById('result-filename').textContent = data.filename;
        
        // Download file
        const url = window.URL.createObjectURL(data.blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = data.filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
    })
    .catch(error => {
        // Hide processing
        document.getElementById('processing-content').classList.add('d-none');
        
        // Show error
        document.getElementById('error-content').classList.remove('d-none');
        document.getElementById('error-message').textContent = error.error || 'Terjadi kesalahan tidak diketahui';
    });
}

// Reset form
function resetForm() {
    selectedFiles = [];
    document.getElementById('gabungTxtForm').reset();
    document.getElementById('output_filename').value = 'merged_files';
    document.getElementById('separator_option').value = 'none';
    document.getElementById('add_filename_headers').checked = false;
    
    // Hide all contents
    document.getElementById('selectedFiles').classList.add('d-none');
    document.getElementById('success-content').classList.add('d-none');
    document.getElementById('error-content').classList.add('d-none');
    document.getElementById('processing-content').classList.add('d-none');
    
    // Go to step 1
    nextStep(1);
    
    // Disable next button
    document.getElementById('nextStepBtn').disabled = true;
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updatePreview();
});
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
